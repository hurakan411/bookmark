# タグ自動提案機能 - 使用方法

## 概要

OpenAI APIを使用して、ブックマークのタイトル、URL、メモから既存のタグリストの中で適切なタグを自動提案する機能です。

## セットアップ手順

### 1. バックエンドのセットアップ

```bash
cd backend

# 仮想環境の作成と有効化
python3 -m venv venv
source venv/bin/activate  # macOS/Linux

# 依存関係のインストール
pip install -r requirements.txt

# 環境変数の設定
cp .env.example .env
```

`.env` ファイルを編集してOpenAI API キーを設定：
```
OPENAI_API_KEY=sk-your-actual-openai-api-key-here
```

### 2. バックエンドサーバーの起動

```bash
# 方法1: 起動スクリプトを使用
./start.sh

# 方法2: 直接実行
python main.py

# 方法3: uvicornを使用
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

サーバーが起動したら：
- API: http://localhost:8000
- Swagger UI: http://localhost:8000/docs

### 3. フロントエンド（Flutter）の起動

別のターミナルで：

```bash
cd frontend
flutter run
```

## 使い方

### アプリでの操作

1. **ブックマーク追加/編集画面を開く**
   - ホーム画面の「追加」ボタンをタップ
   - または既存のブックマークを編集

2. **ブックマーク情報を入力**
   - タイトル（必須）
   - URL（必須）
   - メモ（任意）

3. **AI自動提案ボタンをタップ**
   - タグセクションの「AI自動提案」ボタンをタップ
   - AIが分析を開始します（数秒かかります）

4. **提案されたタグを確認**
   - 既存のタグリストから適切なものが自動選択されます
   - 必要に応じて手動で追加/削除も可能

5. **保存**
   - 「保存」ボタンでブックマークを保存

### 動作例

**入力:**
- タイトル: "Pythonの非同期プログラミング入門"
- URL: "https://example.com/python-async"
- メモ: "asyncioを使った非同期処理の基礎"
- 既存タグ: ["Python", "プログラミング", "AI", "Web開発", "データ分析"]

**出力:**
- 提案されたタグ: ["Python", "プログラミング"]

## トラブルシューティング

### 「タグ提案に失敗しました」エラー

**原因1: バックエンドが起動していない**
```bash
# バックエンドディレクトリで確認
cd backend
./start.sh
```

**原因2: OpenAI API キーが未設定**
- `.env` ファイルに正しいAPIキーが設定されているか確認
- APIキーの形式: `sk-...`

**原因3: ネットワークエラー**
- インターネット接続を確認
- ファイアウォール設定を確認

### 「既存のタグがありません」エラー

- 先にタグを作成してください
- タグ画面で新しいタグを追加

### 「適切なタグが見つかりませんでした」

- 既存のタグとブックマークの内容がマッチしない場合
- より多くのタグを作成するか、手動で選択してください

## API仕様

### POST /suggest-tags

**リクエスト:**
```json
{
  "title": "ブックマークタイトル",
  "url": "https://example.com",
  "excerpt": "メモや説明",
  "existing_tags": ["タグ1", "タグ2", "タグ3"]
}
```

**レスポンス:**
```json
{
  "suggested_tags": ["タグ1", "タグ2"],
  "reasoning": "AIが分析した結果、2個のタグを提案しました。"
}
```

## コスト

- 使用モデル: **gpt-4o-mini**
- 1リクエストあたり: 約0.001〜0.003円
- 月100回使用: 約0.1〜0.3円

## セキュリティ注意事項

1. **API キーの管理**
   - `.env` ファイルは **絶対にGitにコミットしない**
   - `.gitignore` に `.env` が含まれていることを確認

2. **本番環境での設定**
   - CORS設定を適切に制限
   - 必要に応じて認証機構を追加
   - レート制限を設定

3. **データのプライバシー**
   - ブックマーク情報がOpenAIに送信されます
   - 機密情報を含むブックマークには使用を避ける

## カスタマイズ

### タグ提案数の変更

`backend/main.py` の以下の部分を編集：
```python
# 1〜3個 → 1〜5個に変更
content: "上記の既存タグリストの中から、このブックマークに最も適切なタグを1〜5個選んでください"
```

### 使用モデルの変更

```python
model="gpt-4o-mini",  # より高精度が必要な場合は "gpt-4o" に変更
```

### タイムアウト時間の変更

`frontend/lib/services/tag_suggestion_service.dart`:
```dart
.timeout(
  const Duration(seconds: 30),  // 秒数を調整
)
```
